# Javascript Node CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-javascript/ for more details

version: 2.0
references:
  container_config:
    docker:
    - image: circleci/openjdk:8u181-jdk-node-browsers
    working_directory: ~/klassi-cucumber-js
  restore_repo:
    restore_cache:
      keys:
      - v1-repo-{{ .Branch }}-{{ .Revision }}
      - v1-repo-{{ .Branch }}
      - v1-repo
  npm_cache_key: v3-dependency-npm-{{ checksum "package.json" }}
  npm_backup_cache_key: v3-dependency-npm
  restore_npm_dependencies:
    restore_cache:
      keys:
      - v3-dependency-npm-{{ checksum "package.json" }}
      - v3-dependency-npm
  restore_acceptance_builds:
    restore_cache:
      key: v1-acceptance-build-{{ .Branch }}-{{ .Revision }}
jobs:
  checkout_code:
    docker:
    - image: circleci/openjdk:8u181-jdk-node-browsers
    working_directory: ~/klassi-cucumber-js
    steps:
    - restore_cache:
        keys:
        - v1-repo-{{ .Branch }}-{{ .Revision }}
        - v1-repo-{{ .Branch }}
        - v1-repo
    - checkout
    - restore_cache:
        key: v3-dependency-npm-{{ checksum "package.json" }}
    - run:
        name: Install NPM
        command: npm install
    - save_cache:
        key: v3-dependency-npm-{{ checksum "package.json" }}
        paths:
        - node_modules
  acceptance_test_build:
    docker:
    - image: circleci/openjdk:8u181-jdk-node-browsers
    working_directory: ~/klassi-cucumber-js
    steps:
    - restore_cache:
        keys:
        - v1-repo-{{ .Branch }}-{{ .Revision }}
        - v1-repo-{{ .Branch }}
        - v1-repo
    - restore_cache:
        keys:
        - v3-dependency-npm-{{ checksum "package.json" }}
        - v3-dependency-npm
    - checkout
    - store_artifacts:
        path: ./artifacts
    - run: mkdir test-reports
    - run:
        name: Download Selenium
        command: curl -O http://selenium-release.storage.googleapis.com/3.5/selenium-server-standalone-3.5.3.jar
    - run:
        name: Start Selenium Server
        command: java -jar selenium-server-standalone-3.5.3.jar -log test-reports/selenium.log
        background: true
    - run:
        name: Install Dependencies
        command: npm install
    - save_cache:
        paths:
        - node_modules
        key: v1-dependencies-{{ checksum "package.json" }}
    - run: npm run-script dev
  acceptance_test:
    docker:
    - image: circleci/openjdk:8u181-jdk-node-browsers
    working_directory: ~/klassi-cucumber-js
    steps:
    - restore_cache:
        keys:
        - v1-repo-{{ .Branch }}-{{ .Revision }}
        - v1-repo-{{ .Branch }}
        - v1-repo
    - restore_cache:
        keys:
        - v3-dependency-npm-{{ checksum "package.json" }}
        - v3-dependency-npm
    - checkout
    - restore_cache:
        keys:
        - v1-dependencies-{{ checksum "package.json" }}
        - v1-dependencies-
    - run: mkdir test-reports
    - run:
        name: Set BrowserStack Local Identifier
        command: echo 'export BROWSERSTACK_LOCAL_IDENTIFIER=acceptance_test_$BROWSER_NAME_run_$CIRCLE_BUILD_NUM' >> $BASH_ENV
    - run:
        name: Start BrowserStack Local
        command: ./scripts/ci/browserstack-local.sh start
        background: true
    - run:
        name: Install Dependencies
        command: npm install
    - save_cache:
        paths:
        - node_modules
        key: v1-dependencies-{{ checksum "package.json" }}
workflows:
  version: 2
  build_and_test:
    jobs:
    - checkout_code
    - acceptance_test_build:
        requires:
        - checkout_code
    - acceptance_test:
        requires:
        - acceptance_test_build